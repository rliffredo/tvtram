<!DOCTYPE html>
<html>
    <head>
    <title>TV Tram</title>
    <meta charset='utf-8'>
    <style type='text/css'>
        @font-face {
          font-family: BPdots;
          src: url(./BPdotsUnicase.otf);
        }

        @font-face {
          font-family: "BPdots Square";
          src: url(./BPdotsUnicaseSquare.otf);
        }

        @font-face {
          font-family: "BPdots Square Plus";
          src: url(./BPdotsUnicasePlus.otf);
        }

        .wrapper{
           position: relative;
           float: left;
           left: 0.00%;
           width: 100.00%;
        }

        .left{
           position: relative;
           float: left;
           left: 0.00%;
           width: 50.00%;
           height: 1080px;
           border-right: dotted orange;
        }

        .right{
           overflow: hidden;
           height: 1080px;
        }

        .top{
           width:100%;
   height: 640px;
           /*border-bottom: dotted DarkOrange;*/
        }

        .topLeft{
           width:100%;
           height: 980px;
        }

        body {
           border-width: 0px;
           padding: 0px;
           margin: 0px;
           font-size: 2em;
           background-color: #e7e7de;
           color: white;
           background-color: black;
           font-family: "BPdots", sans-serif;
           text-transform:uppercase;
		   width: 1920px;
        }

        ul
        {
            list-style-type: none;
            padding: 0;
            margin: 0px 0px 0px 50px;
        }

        h1
        {
            margin: 10px 0px 10px 50px;
            color: DarkOrange;
			font-size: 1.6em;
        }
		
        li .time{
           float:right;
           padding-right: 70px;
        }

        li .hurry{
           color: #ff3333;
        }

        li .medium{
          color: yellow;
        }

        li .easy{
          color: YellowGreen;
        }
            
        .number{
          width: 2em;
          display: inline-block;
          text-align: right;
		  color: DarkOrange;
        }

        .bus{
          background: transparent url(./img/bus-icon-transparent.png) left 80% no-repeat;
          padding-left: 1em;
          background-size: 0.75em;
        }

        .tram{
          background: transparent url(./img/tram-icon-transparent.png) left 80% no-repeat;
          padding-left: 1em;
          background-size: 0.75em;
        }
			
		.logo
        {
            margin: 0 0 0 240px;
            color: DarkOrange;
			display: inline;
        }
		
		.clock{
			font-size: 1.5em;
			margin: 0 0 0 1em;
			color: DarkOrange;
		}
    </style>
    </head>
    <body>
        <script type="text/html" id="line-template">
            <h1 data-bind="text: name"></h1>
            <ul data-bind="foreach: departures">
                <li><span class="number" data-bind="text: number, css: type"></span> <span data-bind="text: destination"></span> <span class="time" data-bind="text: timeLeft, css: warning"></span></li>
            </ul>
        </script>
        <div class="wrapper">
            <div class="left">
                <div class="topLeft" data-bind="template: { name: 'line-template', data: rondoMatecznego }"></div>
			
                <div class="bottom">
					<span class="clock" data-bind="text: currentTime"></span>
                    <span class="logo">TV Tram - Hack Day 2013</span>
                </div>
            </div>
            <div class="right">
                <div class="top" data-bind="template: { name: 'line-template', data: lagiewniki }"></div>
                <div class="bottom" data-bind="template: { name: 'line-template', data: rzemieslnicza }"></div>
			</div> 
        </div>
        <script src="knockout-2.2.1.js"></script>
        <script src="data.js"></script>
        <script>
            var getCurrentTime = function () {
                var d = new Date();
                //d.setHours(14);
                //d.setMinutes(30);
                return d;
            };
        
            var getDepartureTime = function (now, dep) {
                var parts = dep.time.split(':');
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var departureTime = new Date(now.getTime());
                departureTime.setHours(hours);
                departureTime.setMinutes(minutes);
                // roll over day
                if (departureTime < now) {
                    departureTime.setDate(departureTime.getDate() + 1);
                }
                return departureTime;
            };
        
            var minutesTillDeparture = function (now, dep) {
                var departureTime = getDepartureTime(now, dep);
                var diffMs = departureTime.getTime() - now.getTime();
                var diffMin = Math.floor(diffMs / 1000 / 60);
                return diffMin;
            };
            
            var stringCompare = function (left, right) {
                return left === right
                    ? 0
                    : (left < right ? -1 : 1);
            };
            
            var updateTime = function (stop, now) {
                var entries = 0, i = 0;
                stop.allDepartures.forEach(function (dep) {
                    dep.minutesLeft(minutesTillDeparture(now, dep));
                });
                stop.allDepartures.sort(function (left, right) {
                    var res = left.minutesLeft() - right.minutesLeft();
                    if (res != 0) {
                        return res;
                    }
                    var res = stringCompare(left.number, right.number);
                    if (res != 0) {
                        return res;
                    }
                    return stringCompare(left.destination, right.destination);
                });
                
                stop.departures.removeAll();
                while (entries < stop.maxEntries) {
                    var dep = stop.allDepartures[i++];
                    if (dep.minutesLeft() < stop.minTime) {
                        continue;
                    }
                    stop.departures.push(dep);
                    ++entries;
                }
            };
            
            var createStopVm = function (allData, spec) {
                var stop = allData.stops.filter(function (stop) {
                    return stop.name === spec.name;
                })[0];
                stop.maxEntries = spec.maxEntries;
                stop.minTime = spec.minTime;
                stop.hurryTime = spec.hurryTime;
                stop.mediumTime = spec.mediumTime;
                stop.departures.forEach(function (dep) {
                    dep.type = dep.number.length > 2 ? 'bus' : 'tram';
                    // minutes till departure
                    dep.minutesLeft = ko.observable(0);
                    dep.timeLeft = ko.computed(function () {
                        return this.minutesLeft() + ' min';
                    }, dep);
                    dep.warning = ko.computed(function () {
                        var minLeft = this.minutesLeft();
                        if (minLeft <= stop.hurryTime) {
                            return 'hurry';
                        } else if (minLeft <= stop.mediumTime) {
                            return 'medium';
                        } else {
                            return 'easy';
                        }
                    }, dep);
                });
                stop.allDepartures = stop.departures;
                stop.departures = ko.observableArray([ ]);
                return stop;
            };
            
            var rondoMatecznegoSpec = {
                name: 'Rondo Matecznego',
                maxEntries: 21,
                minTime: 6,
                hurryTime: 6,
                mediumTime: 8
            };
            
            var lagiewnikiSpec = {
                name: 'Łagiewniki',
                maxEntries: 13,
                minTime: 4,
                hurryTime: 6,
                mediumTime: 8
            };
            
            var rzemieslniczaSpec = {
                name: 'Rzemieślnicza',
                maxEntries: 6,
                minTime: 2,
                hurryTime: 6,
                mediumTime: 8
            };
            
            var vm = {
                rondoMatecznego: createStopVm(data, rondoMatecznegoSpec),
                lagiewniki: createStopVm(data, lagiewnikiSpec),
                rzemieslnicza: createStopVm(data, rzemieslniczaSpec),
                currentTime: ko.observable('00:00')
            };
            
            var formatHHMM = function (time) {
                var hours = '00' + time.getHours().toString();
                var minutes = '00' + time.getMinutes().toString();
                return hours.slice(-2) + ':' + minutes.slice(-2);
            };
            
            var updateStops = function () {
                var now = getCurrentTime();
                updateTime(vm.rondoMatecznego, now);
                updateTime(vm.lagiewniki, now);
                updateTime(vm.rzemieslnicza, now);
            };
            
            var updateClock = function () {
                var now = getCurrentTime();
                vm.currentTime(formatHHMM(now));
            };
            
            updateStops();            
            setInterval(updateStops, 1000 * 30);
            
            updateClock();
            setInterval(updateClock, 1000 * 3);
            
            ko.applyBindings(vm);
        </script>
    </body>
</html>
