<!DOCTYPE html>
<html>
    <head>
    <title>TV Tram</title>
    <meta charset='utf-8'>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
    <style type='text/css'>
        @font-face {
          font-family: BPdots;
          src: url(./BPdotsUnicase.eot);
        }
		
		@font-face {
          font-family: BPdots;
          src: url(./BPdotsUnicase.otf);
        }

        .wrapper{
           width: 100.00%;
        }

        .left{
           float: left;
           width: 50%;
        }
		
		.right{
		   float: right;
		   width: 50%;
		}

        body {
           border-width: 0px;
           padding: 0px;
           margin: 0px;
           font-size: 2em;
           background-color: #e7e7de;
           color: white;
           background-color: black;
           font-family: "BPdots", sans-serif;
           text-transform:uppercase;
		   width: 100%;
        }

        ul
        {
            list-style-type: none;
            padding: 0;
            margin: 0px 0px 0px 50px;
        }

        h1
        {
            margin: 10px 0px 10px 50px;
            color: DarkOrange;
			font-size: 1.6em;
        }
		
		li {
			clear:both;
		}
		
        li .time{
           float:right;
           padding-right: 70px;
        }

        li .hurry{
           color: #ff3333;
        }

        li .medium{
          color: yellow;
        }

        li .easy{
          color: YellowGreen;
        }
            
        .number{
          width: 2em;
          display: inline-block;
          text-align: right;
		  color: DarkOrange;
        }

        .bus{
          background: transparent url(./img/bus-icon-transparent.png) left 80% no-repeat;
          padding-left: 1em;
          background-size: 0.75em;
        }

        .tram{
          background: transparent url(./img/tram-icon-transparent.png) left 80% no-repeat;
          padding-left: 1em;
          background-size: 0.75em;
        }
			
		.logo
        {
            margin: 0 50px 0 0;
            color: DarkOrange;
			display: inline;
			float: right;
			line-height: 1.5em;
        }
		
		.clock{
			margin: 0 0 0 50px;
			font-size: 1.5em;
			color: DarkOrange;
		}
		
		.footer{
			margin: 0;
			width: 100%;
			clear: both;
			height: 1.5em;
		}
    </style>
    </head>
    <body>
        <script type="text/html" id="line-template">
            <h1 data-bind="text: name"></h1>
            <ul data-bind="foreach: departures">
                <li><span class="number" data-bind="text: number, css: type"></span> <span data-bind="text: destination"></span> <span class="time" data-bind="text: timeLeft, css: warning"></span></li>
            </ul>
        </script>
        <div class="wrapper">
            <div class="left">
                <div class="topLeft" data-bind="template: { name: 'line-template', data: rondoMatecznego }"></div>		
            </div>
            <div class="right">
                <div class="top" data-bind="template: { name: 'line-template', data: lagiewniki }"></div>
                <div class="bottom" data-bind="template: { name: 'line-template', data: rzemieslnicza }"></div>
			</div> 
			<div class="footer">
				<span class="clock" data-bind="text: currentTime"></span>
				<span class="logo">TV Tram - Hack Day 2013</span>
			</div>
        </div>
        <script src="knockout-2.2.1.js"></script>
        <script src="data.js"></script>
        <script>
		    if(Array.prototype.filter === undefined) {
			    Array.prototype.filter = function(callback) {
				    var result = [];
					var i = 0;
					for(i = 0; i < this.length; i++) {
					   if(callback(this[i], i, this)) {
					      result.push(this[i]);
					   }
					}
					return result;
				}
			}
            var getCurrentTime = function () {
                var d = new Date();
                return d;
            };
        
            var getDepartureTime = function (now, dep) {
                var parts = dep.time.split(':');
                var hours = parseInt(parts[0], 10);
                var minutes = parseInt(parts[1], 10);
                var departureTime = new Date(now.getTime());
                departureTime.setHours(hours);
                departureTime.setMinutes(minutes);
                // roll over day
                if (departureTime < now) {
                    departureTime.setDate(departureTime.getDate() + 1);
                }
                return departureTime;
            };
        
            var minutesTillDeparture = function (now, dep) {
                var departureTime = getDepartureTime(now, dep);
                var diffMs = departureTime.getTime() - now.getTime();
                var diffMin = Math.floor(diffMs / 1000 / 60);
                return diffMin;
            };
            
            var stringCompare = function (left, right) {
                return left === right
                    ? 0
                    : (left < right ? -1 : 1);
            };
            
            var updateTime = function (stop, now) {
                var entries = 0, i = 0;
                stop.allDepartures.forEach(function (dep) {
                    dep.minutesLeft(minutesTillDeparture(now, dep));
                });
                stop.allDepartures.sort(function (left, right) {
                    var res = left.minutesLeft() - right.minutesLeft();
                    if (res != 0) {
                        return res;
                    }
                    var res = stringCompare(left.number, right.number);
                    if (res != 0) {
                        return res;
                    }
                    return stringCompare(left.destination, right.destination);
                });
                
                stop.departures.removeAll();
                while (entries < stop.maxEntries) {
                    var dep = stop.allDepartures[i++];
                    if (dep.minutesLeft() < stop.minTime) {
                        continue;
                    }
                    stop.departures.push(dep);
                    ++entries;
                }
            };
            
            var createStopVm = function (allData, spec) {
                var stop = allData.stops.filter(function (stop) {
                    return stop.name === spec.name;
                })[0];
                stop.maxEntries = spec.maxEntries;
                stop.minTime = spec.minTime;
                stop.hurryTime = spec.hurryTime;
                stop.mediumTime = spec.mediumTime;
                stop.departures.forEach(function (dep) {
                    dep.type = dep.number.length > 2 ? 'bus' : 'tram';
                    // minutes till departure
                    dep.minutesLeft = ko.observable(0);
                    dep.timeLeft = ko.computed(function () {
                        return this.minutesLeft() + ' min';
                    }, dep);
                    dep.warning = ko.computed(function () {
                        var minLeft = this.minutesLeft();
                        if (minLeft <= stop.hurryTime) {
                            return 'hurry';
                        } else if (minLeft <= stop.mediumTime) {
                            return 'medium';
                        } else {
                            return 'easy';
                        }
                    }, dep);
                });
                stop.allDepartures = stop.departures;
                stop.departures = ko.observableArray([ ]);
                return stop;
            };
            
            var rondoMatecznegoSpec = {
                name: 'Rondo Matecznego',
                maxEntries: 22,
                minTime: 5,
                hurryTime: 8,
                mediumTime: 15
            };
            
            var lagiewnikiSpec = {
                name: 'Łagiewniki',
                maxEntries: 13,
                minTime: 4,
                hurryTime: 8,
                mediumTime: 11
            };
            
            var rzemieslniczaSpec = {
                name: 'Rzemieślnicza',
                maxEntries: 6,
                minTime: 2,
                hurryTime: 6,
                mediumTime: 8
            };
            
            var createVm = function (data) {
                var vm = {
                    rondoMatecznego: createStopVm(data, rondoMatecznegoSpec),
                    lagiewniki: createStopVm(data, lagiewnikiSpec),
                    rzemieslnicza: createStopVm(data, rzemieslniczaSpec),
                    currentTime: ko.observable('00:00')
                };
                
                var formatHHMM = function (time) {
                    var hours = '00' + time.getHours().toString();
                    var minutes = '00' + time.getMinutes().toString();
                    return hours.slice(-2) + ':' + minutes.slice(-2);
                };
            
                vm.updateStops = function (now) {
                    updateTime(this.rondoMatecznego, now);
                    updateTime(this.lagiewniki, now);
                    updateTime(this.rzemieslnicza, now);
                };
            
                vm.updateClock = function (now) {
                    this.currentTime(formatHHMM(now));
                };
				              
                return vm;
            };
            
            var data = localData;
			
			var calculateNextRefresh = function () {
			    var now = getCurrentTime();
				return 60 - now.getSeconds();
			};
			
			var updateView = function () {
				var now = getCurrentTime();
			    updateStops(now);
				updateClock(now);
				setTimeout(function() { updateView(); }, calculateNextRefresh() * 1000);
			}
			
            var runApp = function () {
                var vm = createVm(data);
                updateStops = vm.updateStops.bind(vm);
                updateClock = vm.updateClock.bind(vm);
				updateView();               
                ko.applyBindings(vm);                
            };
            
            /*
            $(function () {
                $.get('http://localhost:8080')
                    .done(function (serviceData) {
                        data = serviceData;
                        runApp();
                    });
            });
            */
            
            runApp();
        </script>
    </body>
</html>
